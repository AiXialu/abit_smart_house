<view class="container">
  <!-- ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ -->
  <view class="network-status-bar">
    <view class="network-status-content">
      <text class="status-icon">ğŸŒ</text>
      <text class="status-text" wx:if="{{networkStatus === 'online'}}">åœ¨çº¿æ¨¡å¼</text>
      <text class="status-text" wx:elif="{{networkStatus === 'offline'}}">ç¦»çº¿æ¨¡å¼</text>
      <text class="status-text" wx:else>è¿æ¥ä¸­...</text>
      <view class="status-actions">
        <button wx:if="{{networkStatus === 'offline'}}" class="retry-btn" bindtap="testNetworkConnection">é‡è¯•</button>
        <button class="diagnostic-btn" bindtap="runNetworkDiagnostic">è¯Šæ–­</button>
      </view>
    </view>
  </view>

  <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
  <view class="user-card">
    <view wx:if="{{hasUserInfo}}" class="user-info">
      <image wx:if="{{userInfo.avatarUrl}}" class="user-avatar" src="{{userInfo.avatarUrl}}"></image>
      <view class="user-details">
        <text class="user-name">{{userInfo.nickName}}</text>
        <view wx:if="{{userInfo.isAnonymous || userInfo.isTemporary}}" class="anonymous-user-actions">
          <text class="user-status" wx:if="{{userInfo.isDemoted}}">ğŸ”’ å¾®ä¿¡è„±æ•æ•°æ®</text>
          <text class="user-status" wx:elif="{{userInfo.isTemporary}}">ğŸ‘¤ ä¸´æ—¶ç”¨æˆ·</text>
          <text class="user-status" wx:else>â“ åŒ¿åç”¨æˆ·</text>
          <button class="get-real-info-btn" bindtap="getUserInfo">ğŸ” é‡æ–°è·å–å¾®ä¿¡ä¿¡æ¯</button>
        </view>
        <text wx:else class="user-status">âœ… çœŸå®å¾®ä¿¡ç”¨æˆ·</text>
      </view>
    </view>
    <view wx:else class="no-user-info">
      <text class="hint-text">è·å–ç”¨æˆ·ä¿¡æ¯ä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½</text>
      <button class="get-user-info-btn" bindtap="getUserInfo">è·å–ç”¨æˆ·ä¿¡æ¯</button>
    </view>
  </view>

  <!-- æ´—è¡£æœºçŠ¶æ€å¤§å¡ç‰‡ -->
  <view class="main-status-card">
    <view class="status-header">
      <text class="status-title">ğŸ§º æ´—è¡£æœºçŠ¶æ€</text>
      <button class="refresh-btn" bindtap="refreshStatus">ğŸ”„</button>
    </view>
    
    <view class="status-display">
      <view class="status-indicator {{status.status}}">
        <text class="status-text">{{getStatusText(status.status)}}</text>
      </view>
      
      <view wx:if="{{status.status === 'in_use'}}" class="current-usage">
        <view class="usage-user">
          <text>ğŸ§‘â€ğŸ’¼ ä½¿ç”¨è€…ï¼š{{status.current_user_name}}</text>
        </view>
        <view class="usage-time">
          <text>â° å¼€å§‹æ—¶é—´ï¼š{{formatTime(status.start_time)}}</text>
          <text>â³ é¢„è®¡ç»“æŸï¼š{{formatTime(status.estimated_end_time)}}</text>
        </view>
        <view class="remaining-time">
          <text>å‰©ä½™æ—¶é—´ï¼š{{getRemainingTime(status.estimated_end_time)}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ä¸»è¦æ“ä½œæŒ‰é’®åŒºåŸŸ -->
  <view class="main-actions">
    <!-- å°ç¨‹åºé€šçŸ¥åŠŸèƒ½ -->
    <view class="notification-section">
      <view class="section-header">
        <text class="section-title">ğŸ  ç¾¤ç»„é€šçŸ¥ç³»ç»Ÿ</text>
        <button class="manage-group-btn" bindtap="manageGroup">
          {{currentGroup ? 'ç®¡ç†ç¾¤ç»„' : 'åˆ›å»º/åŠ å…¥ç¾¤ç»„'}}
        </button>
      </view>
      
      <!-- ç¾¤ç»„ä¿¡æ¯ -->
      <view wx:if="{{currentGroup}}" class="group-info">
        <view class="group-details">
          <text class="group-name">{{currentGroup.name}}</text>
          <text class="group-stats">{{groupMembers.length}}äºº Â· ç¾¤å·:{{currentGroup.id}}</text>
        </view>
        <view class="subscription-toggle">
          <button 
            class="subscription-btn {{isSubscribed ? 'subscribed' : 'unsubscribed'}}" 
            bindtap="toggleSubscription"
          >
            {{isSubscribed ? 'âœ… å·²è®¢é˜…' : 'âŒ æœªè®¢é˜…'}}
          </button>
        </view>
      </view>
      
      <!-- æ— ç¾¤ç»„æç¤º -->
      <view wx:else class="no-group-hint">
        <text class="hint-text">ğŸ  åˆ›å»ºæˆ–åŠ å…¥ç¾¤ç»„åï¼Œå³å¯å‘ç¾¤æˆå‘˜å‘é€é€šçŸ¥</text>
      </view>
      
      <view wx:if="{{currentGroup}}" class="notification-stats">
        <text class="stats-item">åœ¨çº¿æˆå‘˜ï¼š{{onlineUsers.length}}/{{groupMembers.length}}äºº</text>
        <button wx:if="{{unreadCount > 0}}" class="unread-badge" bindtap="showNotificationHistory">
          {{unreadCount}}æ¡æœªè¯»
        </button>
        <button wx:else class="notification-history-btn" bindtap="showNotificationHistory">
          é€šçŸ¥å†å²
        </button>
      </view>
      
      <button 
        wx:if="{{currentGroup && isSubscribed}}" 
        class="primary-action-btn in-app-notify-btn" 
        bindtap="showNotifyOptions"
        data-mode="in-app"
      >
        ğŸ“± å‘é€ç¾¤ç»„é€šçŸ¥
      </button>
    </view>

    <!-- ä¼ ç»Ÿç¾¤é€šçŸ¥åŠŸèƒ½ -->
    <view class="traditional-section">
      <view class="section-header">
        <text class="section-title">ğŸ’¬ ä¼ ç»Ÿç¾¤æ¶ˆæ¯</text>
      </view>
      <view class="share-actions">
        <button class="primary-action-btn share-btn" bindtap="quickShare">
          ğŸ“¤ åˆ†äº«åˆ°å¾®ä¿¡ç¾¤
        </button>
        <button class="secondary-action-btn notify-group-btn" bindtap="showNotifyOptions" data-mode="copy">
          ğŸ“‹ å¤åˆ¶ç¾¤é€šçŸ¥æ¶ˆæ¯
        </button>
      </view>
      <view class="group-setup-hint">
        <text class="hint-text">ğŸ’¡ å¯ä»¥ç›´æ¥åˆ†äº«åˆ°å¾®ä¿¡ç¾¤ï¼Œæˆ–ç”Ÿæˆæ¶ˆæ¯å¤åˆ¶ç²˜è´´</text>
      </view>
    </view>

    <!-- æ´—è¡£æœºæ“ä½œæŒ‰é’® -->
    <view class="washing-actions">
      <button 
        wx:if="{{status.status === 'idle'}}" 
        class="action-btn start-btn" 
        bindtap="startUsing"
      >
        ğŸš€ å¼€å§‹ä½¿ç”¨
      </button>
      
      <button 
        wx:if="{{status.status === 'in_use' && isCurrentUser}}" 
        class="action-btn finish-btn" 
        bindtap="finishUsing"
      >
        âœ… ä½¿ç”¨å®Œæˆ
      </button>
      
      <button 
        wx:if="{{status.status === 'in_use' && !isCurrentUser}}" 
        class="action-btn waiting-btn" 
        bindtap="showWaitingOptions"
      >
        â° æˆ‘ä¹Ÿæƒ³ç”¨
      </button>
    </view>
  </view>

  <!-- å®šæ—¶æé†’è®¾ç½® -->
  <view wx:if="{{status.status === 'in_use' && isCurrentUser}}" class="reminder-card">
    <view class="reminder-header">
      <text class="reminder-title">â° å®Œæˆæé†’</text>
    </view>
    <view class="reminder-content">
      <text class="reminder-desc">æ´—è¡£å®Œæˆæ—¶è‡ªåŠ¨æé†’ç¾¤å†…æˆå‘˜</text>
      <button 
        class="reminder-btn {{reminderEnabled ? 'enabled' : 'disabled'}}" 
        bindtap="toggleReminder"
      >
        {{reminderEnabled ? 'âœ… å·²å¼€å¯' : 'âŒ æœªå¼€å¯'}}
      </button>
    </view>
  </view>

  <!-- å¿«é€ŸåŠŸèƒ½ -->
  <view class="quick-functions">
    <view class="section-title">âš¡ å¿«é€ŸåŠŸèƒ½</view>
    
    <!-- åˆ†äº«åŠŸèƒ½è¯´æ˜ -->
    <view class="share-guide">
      <view class="guide-header">
        <text class="guide-title">ğŸ“¤ åˆ†äº«åŠŸèƒ½ä½¿ç”¨æŒ‡å—</text>
      </view>
      <view class="guide-content">
        <view class="guide-item">
          <text class="guide-icon">1ï¸âƒ£</text>
          <text class="guide-text">ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸ï¼ˆæ˜¾ç¤º"åœ¨çº¿æ¨¡å¼"ï¼‰</text>
        </view>
        <view class="guide-item">
          <text class="guide-icon">2ï¸âƒ£</text>
          <text class="guide-text">ç‚¹å‡»"åˆ†äº«åˆ°å¾®ä¿¡ç¾¤"æŒ‰é’®</text>
        </view>
        <view class="guide-item">
          <text class="guide-icon">3ï¸âƒ£</text>
          <text class="guide-text">ç‚¹å‡»å³ä¸Šè§’"..."é€‰æ‹©å‘é€ç»™æœ‹å‹</text>
        </view>
        <view class="guide-item">
          <text class="guide-icon">4ï¸âƒ£</text>
          <text class="guide-text">é€‰æ‹©ç›®æ ‡ç¾¤èŠï¼Œå‘é€å®Œæˆï¼</text>
        </view>
      </view>
      
      <!-- ç½‘ç»œè¿æ¥è¯´æ˜ -->
      <view wx:if="{{networkStatus === 'offline'}}" class="network-guide">
        <view class="network-guide-header">
          <text class="guide-icon">âš ï¸</text>
          <text class="guide-title">ç½‘ç»œè¿æ¥é—®é¢˜è§£å†³æ–¹æ³•</text>
        </view>
        <view class="guide-content">
          <view class="guide-item">
            <text class="guide-icon">âœ…</text>
            <text class="guide-text">ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼ˆç«¯å£3000ï¼‰</text>
          </view>
          <view class="guide-item">
            <text class="guide-icon">âœ…</text>
            <text class="guide-text">å¾®ä¿¡å¼€å‘è€…å·¥å…· â†’ è¯¦æƒ… â†’ æœ¬åœ°è®¾ç½®</text>
          </view>
          <view class="guide-item">
            <text class="guide-icon">âœ…</text>
            <text class="guide-text">å‹¾é€‰"ä¸æ ¡éªŒåˆæ³•åŸŸå"é€‰é¡¹</text>
          </view>
          <view class="guide-item">
            <text class="guide-icon">âœ…</text>
            <text class="guide-text">é‡æ–°ç¼–è¯‘é¡¹ç›®å¹¶ç‚¹å‡»"é‡è¯•"æŒ‰é’®</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="quick-btn-grid">
      <button class="quick-btn" bindtap="goToHistory">
        <text class="quick-btn-icon">ğŸ“Š</text>
        <text class="quick-btn-text">ä½¿ç”¨å†å²</text>
      </button>
      <button class="quick-btn" bindtap="goToReserve">
        <text class="quick-btn-icon">ğŸ“…</text>
        <text class="quick-btn-text">ç®€å•é¢„çº¦</text>
      </button>
      <button class="quick-btn" bindtap="showNotifyOptions">
        <text class="quick-btn-icon">ğŸ“¢</text>
        <text class="quick-btn-text">å¿«é€Ÿé€šçŸ¥</text>
      </button>
      <button class="quick-btn" bindtap="showSettings">
        <text class="quick-btn-icon">ğŸ› ï¸</text>
        <text class="quick-btn-text">æ›´å¤šè®¾ç½®</text>
      </button>
    </view>
  </view>

  <!-- é¢„çº¦åˆ—è¡¨ (ç®€åŒ–æ˜¾ç¤º) -->
  <view wx:if="{{reservations.length > 0}}" class="simple-reservations">
    <view class="section-title">ğŸ“… ä»Šæ—¥é¢„çº¦ ({{reservations.length}}ä¸ª)</view>
    <view class="reservation-preview">
      <view 
        wx:for="{{reservations}}" 
        wx:for-index="idx"
        wx:key="id" 
        wx:if="{{idx < 2}}"
        class="reservation-item-simple"
      >
        <text class="reservation-user">{{item.user_name}}</text>
        <text class="reservation-time">{{formatTime(item.reserved_time)}}</text>
      </view>
      <text wx:if="{{reservations.length > 2}}" class="more-reservations">
        è¿˜æœ‰{{reservations.length - 2}}ä¸ªé¢„çº¦...
      </text>
    </view>
  </view>
</view>

<!-- é€šçŸ¥ç¾¤é€‰é¡¹å¼¹çª— -->
<view wx:if="{{showNotifyModal}}" class="modal-overlay" bindtap="hideNotifyModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ğŸ“¢ é€‰æ‹©é€šçŸ¥å†…å®¹</text>
      <button class="modal-close" bindtap="hideNotifyModal">âœ•</button>
    </view>
    <view class="modal-body">
      <view class="modal-tips">
        <text class="tips-text">ğŸ’¡ é€‰æ‹©é€šçŸ¥å†…å®¹åï¼Œå¯ä»¥ç›´æ¥åˆ†äº«åˆ°å¾®ä¿¡ç¾¤æˆ–å¤åˆ¶æ¶ˆæ¯</text>
      </view>
      
      <!-- ç¾¤ç»„æˆå‘˜é€‰æ‹©å™¨ (ä»…åœ¨ç¾¤ç»„é€šçŸ¥æ¨¡å¼ä¸‹æ˜¾ç¤º) -->
      <view wx:if="{{currentNotifyMode === 'in-app' && currentGroup}}" class="member-selector-section">
        <view class="selector-header">
          <text class="selector-title">ğŸ“‹ é€‰æ‹©é€šçŸ¥å¯¹è±¡</text>
          <view class="select-actions">
            <button class="select-all-btn" bindtap="selectAllMembers">å…¨é€‰</button>
            <button class="select-none-btn" bindtap="selectNoneMembers">å…¨ä¸é€‰</button>
          </view>
        </view>
        <view class="members-grid">
          <view 
            wx:for="{{groupMembers}}" 
            wx:key="userId" 
            class="member-item {{selectedMembers.includes(item.userId) ? 'selected' : ''}}"
            bindtap="toggleMemberSelection"
            data-user-id="{{item.userId}}"
          >
            <text class="member-name">{{item.userName}}</text>
            <text wx:if="{{item.userId === currentGroup.ownerId}}" class="owner-badge">ç¾¤ä¸»</text>
            <view class="selection-indicator">
              {{selectedMembers.includes(item.userId) ? 'âœ…' : 'âšª'}}
            </view>
          </view>
        </view>
        <view class="selection-summary">
          <text class="summary-text">å·²é€‰æ‹© {{selectedMembers.length}}/{{groupMembers.length}} äºº</text>
        </view>
      </view>
      
      <!-- @äººå‘˜è®¾ç½® (ä»…åœ¨ä¼ ç»Ÿç¾¤æ¶ˆæ¯æ¨¡å¼ä¸‹æ˜¾ç¤º) -->
      <view wx:if="{{currentNotifyMode === 'copy'}}" class="at-setting-section">
        <view class="section-header">
          <text class="section-title">ğŸ·ï¸ @äººå‘˜è®¾ç½®</text>
          <button class="manage-members-btn" bindtap="manageMembers">ç®¡ç†</button>
        </view>
        <view class="at-mode-selector">
          <button 
            class="at-mode-btn {{atMode === 'all' ? 'active' : ''}}" 
            bindtap="setAtMode" 
            data-mode="all"
          >
            @æ‰€æœ‰äºº
          </button>
          <button 
            class="at-mode-btn {{atMode === 'specific' ? 'active' : ''}}" 
            bindtap="setAtMode" 
            data-mode="specific"
          >
            @æŒ‡å®šäºº
          </button>
          <button 
            class="at-mode-btn {{atMode === 'none' ? 'active' : ''}}" 
            bindtap="setAtMode" 
            data-mode="none"
          >
            ä¸@äºº
          </button>
        </view>
        <view wx:if="{{atMode === 'specific' && commonMembers.length > 0}}" class="common-members">
          <text class="members-label">å¸¸ç”¨@ï¼š</text>
          <view class="members-list">
            <text wx:for="{{commonMembers}}" wx:key="*this" class="member-tag">{{item}}</text>
          </view>
        </view>
      </view>
      
      <button class="notify-option-btn" bindtap="notifyCurrentStatus">
        ğŸ“‹ é€šçŸ¥å½“å‰çŠ¶æ€
      </button>
      <button wx:if="{{status.status === 'in_use'}}" class="notify-option-btn" bindtap="askWhenFinish">
        â“ è¯¢é—®è¿˜éœ€å¤šä¹…
      </button>
      <button class="notify-option-btn share-option-btn" bindtap="shareCurrentStatus" data-mode="share">
        ğŸ“¤ åˆ†äº«åˆ°å¾®ä¿¡ç¾¤
      </button>
      <button class="notify-option-btn" bindtap="customNotify">
        âœï¸ è‡ªå®šä¹‰é€šçŸ¥å†…å®¹
      </button>
    </view>
  </view>
</view> 